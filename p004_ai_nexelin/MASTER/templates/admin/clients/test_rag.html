{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Test RAG Console{% endblock %}

{% block extrahead %}
<style>
.rag-test-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
}

.rag-form-group {
    margin-bottom: 20px;
}

.rag-form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
}

.rag-form-group select,
.rag-form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
}

.rag-form-group textarea {
    min-height: 120px;
    font-family: inherit;
    resize: vertical;
}

.rag-send-btn {
    background: #417690;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 15px;
    font-weight: bold;
}

.rag-send-btn:hover:not(:disabled) {
    background: #2e5266;
}

.rag-send-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.rag-response-section {
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.rag-response-section h3 {
    margin-top: 0;
    color: #417690;
}

.rag-answer {
    background: white;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    white-space: pre-wrap;
    line-height: 1.6;
}

.rag-sources {
    margin-top: 20px;
}

.rag-sources-header {
    cursor: pointer;
    user-select: none;
    font-weight: bold;
    margin-bottom: 10px;
    color: #666;
}

.rag-sources-header:hover {
    color: #417690;
}

.rag-sources-list {
    background: white;
    padding: 15px;
    border-radius: 4px;
}

.rag-source-item {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.rag-source-item:last-child {
    border-bottom: none;
}

.rag-loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.rag-error {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 4px;
    margin-top: 20px;
}

.rag-hidden {
    display: none;
}

.rag-context-info {
    background: #e7f3ff;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 20px;
    font-size: 14px;
}

.rag-context-info strong {
    color: #417690;
}

.rag-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #417690;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:clients_client_changelist' %}">Clients</a>
    &rsaquo; Test RAG Console
    </div>
{% endblock %}

{% block content %}
<div class="rag-test-container">
    <h1>RAG Test Console</h1>
    
    <div class="rag-context-info">
        <strong>Testing context:</strong>
        {% if client %}
            Client: {{ client.user.get_full_name }} ({{ client.company_name }})
            {% if specialization %}
                | Specialization: {{ specialization.name }}
            {% endif %}
            {% if branch %}
                | Branch: {{ branch.name }}
            {% endif %}
        {% else %}
            No context selected
        {% endif %}
    </div>

    <form id="ragTestForm">
        {% csrf_token %}
        
        <input type="hidden" id="clientId" value="{{ client.id|default:'' }}">
        <input type="hidden" id="branchId" value="{{ branch.id|default:'' }}">
        <input type="hidden" id="specializationId" value="{{ specialization.id|default:'' }}">

        <div class="rag-form-group">
            <label for="query">Your Question:</label>
            <textarea id="query" name="query" placeholder="Ask a question..." required></textarea>
        </div>

        <button type="submit" class="rag-send-btn" id="sendBtn">Send Query</button>
    </form>

    <div id="loadingSection" class="rag-loading rag-hidden">
        <div class="rag-spinner"></div>
        <p>Processing your query...</p>
    </div>

    <div id="errorSection" class="rag-error rag-hidden"></div>

    <div id="responseSection" class="rag-response-section rag-hidden">
        <h3>Response:</h3>
        <div id="answerText" class="rag-answer"></div>

        <div class="rag-sources">
            <div class="rag-sources-header" onclick="toggleSources()">
                â–¼ Sources (<span id="sourcesCount">0</span>)
            </div>
            <div id="sourcesList" class="rag-sources-list"></div>
        </div>

        <div style="margin-top: 15px; font-size: 13px; color: #666;">
            <strong>Chunks used:</strong> <span id="chunksCount">0</span> |
            <strong>Tokens:</strong> <span id="tokensCount">0</span>
        </div>
    </div>
</div>

<script>
const form = document.getElementById('ragTestForm');
const queryInput = document.getElementById('query');
const sendBtn = document.getElementById('sendBtn');
const loadingSection = document.getElementById('loadingSection');
const errorSection = document.getElementById('errorSection');
const responseSection = document.getElementById('responseSection');
const answerText = document.getElementById('answerText');
const sourcesList = document.getElementById('sourcesList');
const sourcesCount = document.getElementById('sourcesCount');
const chunksCount = document.getElementById('chunksCount');
const tokensCount = document.getElementById('tokensCount');

function toggleSources() {
    sourcesList.classList.toggle('rag-hidden');
}

function showError(message) {
    errorSection.textContent = message;
    errorSection.classList.remove('rag-hidden');
    loadingSection.classList.add('rag-hidden');
}

function hideError() {
    errorSection.classList.add('rag-hidden');
}

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const query = queryInput.value.trim();
    if (!query) return;

    hideError();
    responseSection.classList.add('rag-hidden');
    loadingSection.classList.remove('rag-hidden');
    sendBtn.disabled = true;

    const clientId = document.getElementById('clientId').value;
    const branchId = document.getElementById('branchId').value;
    const specializationId = document.getElementById('specializationId').value;

    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const response = await fetch('/api/clients/rag-test/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                query: query,
                client_id: clientId || null,
                branch_id: branchId || null,
                specialization_id: specializationId || null
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Request failed');
        }

        answerText.textContent = data.answer;
        
        sourcesList.innerHTML = '';
        if (data.sources && data.sources.length > 0) {
            data.sources.forEach(source => {
                const item = document.createElement('div');
                item.className = 'rag-source-item';
                item.textContent = `Found in "${source.title}" (${source.level}) - similarity: ${(source.similarity * 100).toFixed(1)}%`;
                sourcesList.appendChild(item);
            });
            sourcesCount.textContent = data.sources.length;
        } else {
            sourcesList.innerHTML = '<div class="rag-source-item">No sources found</div>';
            sourcesCount.textContent = '0';
        }

        chunksCount.textContent = data.num_chunks || 0;
        tokensCount.textContent = data.total_tokens || 0;

        responseSection.classList.remove('rag-hidden');
        loadingSection.classList.add('rag-hidden');

    } catch (error) {
        showError(`Error: ${error.message}`);
    } finally {
        sendBtn.disabled = false;
    }
});

queryInput.addEventListener('input', () => {
    sendBtn.disabled = !queryInput.value.trim();
});
</script>
{% endblock %}


