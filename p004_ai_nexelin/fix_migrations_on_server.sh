#!/bin/bash
# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ñ–ĞºÑ‚Ñƒ Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ğ¹ Django Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–
# Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ: bash fix_migrations_on_server.sh

set -e  # Ğ—ÑƒĞ¿Ğ¸Ğ½Ğ¸Ñ‚Ğ¸ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ñ†Ñ–

echo "ğŸ”§ ĞŸĞ¾Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ²Ğ¸Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ğ¹ Django..."
echo ""

# ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ‰Ğ¾ Ğ¼Ğ¸ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ–Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ—
if [ ! -d "MASTER/clients/migrations" ]; then
    echo "âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ĞĞµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ MASTER/clients/migrations"
    echo "   ĞŸĞµÑ€ĞµĞºĞ¾Ğ½Ğ°Ğ¹Ñ‚ĞµÑÑ Ñ‰Ğ¾ Ğ²Ğ¸ Ğ² /opt/p004_ai_nexelin"
    exit 1
fi

echo "ĞšÑ€Ğ¾Ğº 1: ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½ Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ğ¹..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ls -lah MASTER/clients/migrations/ | grep "^-" | grep "\.py$" | tail -15
echo ""

echo "ĞšÑ€Ğ¾Ğº 2: Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ ĞºĞµÑˆ Python Ğ´Ğ»Ñ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‚Ñƒ..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
find MASTER/clients/migrations -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find MASTER/clients/migrations -name "*.pyc" -delete 2>/dev/null || true
echo "âœ“ ĞšĞµÑˆ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ¾"
echo ""

echo "ĞšÑ€Ğ¾Ğº 3: Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ ĞºĞ¾Ğ½Ñ„Ğ»Ñ–ĞºÑ‚Ğ½Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ» 0016_add_unique_tag_constraint.py..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -f "MASTER/clients/migrations/0016_add_unique_tag_constraint.py" ]; then
    rm -f MASTER/clients/migrations/0016_add_unique_tag_constraint.py
    echo "âœ“ Ğ¤Ğ°Ğ¹Ğ» 0016_add_unique_tag_constraint.py Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ¾"
else
    echo "  Ğ¤Ğ°Ğ¹Ğ» 0016_add_unique_tag_constraint.py Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ (Ñ†Ğµ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾)"
fi
echo ""

echo "ĞšÑ€Ğ¾Ğº 4: ĞšĞ¾Ğ¿Ñ–ÑÑ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ñ— 0019..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# Ğ¤Ğ°Ğ¹Ğ» Ğ²Ğ¶Ğµ Ğ¼Ğ°Ñ” Ğ±ÑƒÑ‚Ğ¸ Ğ² git Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ñ–Ñ—
if [ -f "MASTER/clients/migrations/0019_add_unique_tag_constraint.py" ]; then
    echo "âœ“ Ğ¤Ğ°Ğ¹Ğ» 0019_add_unique_tag_constraint.py Ğ²Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”"
else
    echo "âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: Ğ¤Ğ°Ğ¹Ğ» 0019_add_unique_tag_constraint.py Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ² git"
    echo "   Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ·Ñ€Ğ¾Ğ±Ñ–Ñ‚ÑŒ git pull"
    exit 1
fi
echo ""

echo "ĞšÑ€Ğ¾Ğº 5: ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ Ñ‰Ğ¾ Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ñ— 0017 Ñ‚Ğ° 0018 Ñ–ÑĞ½ÑƒÑÑ‚ÑŒ..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ ! -f "MASTER/clients/migrations/0017_client_embedding_model_clientqrcode_and_more.py" ]; then
    echo "âš ï¸  Ğ£Ğ²Ğ°Ğ³Ğ°: Ğ¤Ğ°Ğ¹Ğ» 0017 Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
    echo "   ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ¹Ğ¾Ğ³Ğ¾ Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Docker"
fi

if [ ! -f "MASTER/clients/migrations/0018_merge_20251104_1619.py" ]; then
    echo "âš ï¸  Ğ£Ğ²Ğ°Ğ³Ğ°: Ğ¤Ğ°Ğ¹Ğ» 0018 Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
    echo "   ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾ ÑĞºĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¹Ğ¾Ğ³Ğ¾ Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Docker"
fi
echo ""

echo "ĞšÑ€Ğ¾Ğº 6: ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ Ñ„Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¼Ñ–Ğ³Ñ€Ğ°Ñ†Ñ–Ğ¹..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ls -lh MASTER/clients/migrations/*.py | tail -10
echo ""

echo "ĞšÑ€Ğ¾Ğº 7: ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ Docker ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker-compose restart ai_nexelin_web
echo "âœ“ ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾"
echo ""

echo "ĞšÑ€Ğ¾Ğº 8: ĞÑ‡Ñ–ĞºÑƒÑ 5 ÑĞµĞºÑƒĞ½Ğ´ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°..."
sleep 5
echo ""

echo "ĞšÑ€Ğ¾Ğº 9: ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ Ğ»Ğ¾Ğ³Ğ¸..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker logs ai_nexelin_web 2>&1 | tail -30
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ¾!"
echo ""
echo "Ğ¯ĞºÑ‰Ğ¾ Ğ²ÑĞµ Ñ‰Ğµ Ñ” Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸:"
echo "1. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ñ‡Ğ¸ Ñ–ÑĞ½ÑƒÑÑ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ¸ 0017 Ñ‚Ğ° 0018 Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ–"
echo "2. ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾ ÑĞºĞ¾Ğ¿Ñ–ÑĞ²Ğ°Ñ‚Ğ¸ Ñ—Ñ… Ğ· Docker ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°:"
echo "   docker cp ai_nexelin_web:/app/MASTER/clients/migrations/0017_client_embedding_model_clientqrcode_and_more.py MASTER/clients/migrations/"
echo "   docker cp ai_nexelin_web:/app/MASTER/clients/migrations/0018_merge_20251104_1619.py MASTER/clients/migrations/"
echo "3. ĞŸĞ¾Ñ‚Ñ–Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ Ñ†ĞµĞ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ½Ğ¾Ğ²Ñƒ"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
